<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<meta name="generator" content="AsciiDoc 8.6.9">
<title>jnanomsg documentation</title>
<link rel="stylesheet" href="static/niwi.css" type="text/css">
<link rel="stylesheet" href="static/pygments.css" type="text/css">


<script type="text/javascript" src="static/asciidoc.js"></script>
<script type="text/javascript" src="static/niwi.js"></script>
<script type="text/javascript">
/*<![CDATA[*/
asciidoc.install(2);
/*]]>*/
</script>
</head>
<body class="article" style="max-width:800px">
<div id="header">
<h1>jnanomsg documentation</h1>
<span id="author">Andrey Antukh,</span><br>
<span id="email" class="monospaced">&lt;<a href="mailto:niwi@niwi.be">niwi@niwi.be</a>&gt;</span><br>
<span id="revnumber">version 0.2.0,</span>
<span id="revdate">2014-01-08</span>
<div id="toc">
  <div id="toctitle">Table of Contents</div>
  <noscript><p><b>JavaScript must be enabled in your browser to display the table of contents.</b></p></noscript>
</div>
</div>
<div id="content">
<div class="sect1">
<h2 id="_introduction">1. Introduction</h2>
<div class="sectionbody">
<div class="paragraph"><p><a href="http://nanomsg.org">nanomsg</a> is a socket library that provides common communication patterns.
It aims to make the networking layer fast, scalable, and easy to use.</p></div>
<div class="paragraph"><p>Api documentation for <a href="api/clojure/index.html">Clojure</a> and <a href="api/java/index.html">Java</a>.</p></div>
</div>
</div>
<div class="sect1">
<h2 id="_project_maturity">2. Project Maturity</h2>
<div class="sectionbody">
<div class="paragraph"><p><em>jnanomsg</em> is a young project and can experiment some api changes.</p></div>
</div>
</div>
<div class="sect1">
<h2 id="_install">3. Install</h2>
<div class="sectionbody">
<div class="paragraph"><p>This section covers a installation of <em>jnanomsg</em>.</p></div>
<div class="sect2">
<h3 id="_leiningen">3.1. Leiningen</h3>
<div class="paragraph"><p>The simplest way to use <em>jnanomsg</em> on clojure project, is including it on dependency
vector of your <strong><em>project.clj</em></strong> file:</p></div>
<div class="listingblock">
<div class="title"><em>on project.clj</em></div>
<div class="content"><div class="highlight"><pre><span class="p">[</span><span class="nv">jnanomsg</span> <span class="s">&quot;0.2.0&quot;</span><span class="p">]</span>
</pre></div></div></div>
</div>
<div class="sect2">
<h3 id="_maven">3.2. Maven</h3>
<div class="paragraph"><p>Also, you can use it on your java projects with maven. As first step add a clojars repository:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nt">&lt;repository&gt;</span>
    <span class="nt">&lt;id&gt;</span>clojars.org<span class="nt">&lt;/id&gt;</span>
    <span class="nt">&lt;url&gt;</span>http://clojars.org/repo<span class="nt">&lt;/url&gt;</span>
<span class="nt">&lt;/repository&gt;</span>
</pre></div></div></div>
<div class="paragraph"><p>Following of jnanomsg package dependecy:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>jnanomsg<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>jnanomsg<span class="nt">&lt;/artifactId&gt;</span>
    <span class="nt">&lt;version&gt;</span>0.2.0<span class="nt">&lt;/version&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
</pre></div></div></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_supported_features">4. Supported features</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_transports">4.1. Transports</h3>
<div class="paragraph"><p>jnanomsg supports all transports supported by their backend (nanomsg): ipc, inproc, tcp</p></div>
</div>
<div class="sect2">
<h3 id="_protocols">4.2. Protocols</h3>
<div class="paragraph"><p>jnanomsg intends support all protocols supported by a native nanomsg library, but currently
it only has support for this few protocols:</p></div>
<div class="ulist"><ul>
<li>
<p>
pub/sub protocol
</p>
</li>
<li>
<p>
req/rep protocol
</p>
</li>
<li>
<p>
push/pull (pipeline) protocol
</p>
</li>
<li>
<p>
bus protocol
</p>
</li>
<li>
<p>
pair protocol
</p>
</li>
</ul></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">This documentation not intends explain how works each protocol. It intends only explain
a public api of idiomatic library for java and clojure.</td>
</tr></table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_user_guide">5. User guide</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_introduction_2">5.1. Introduction</h3>
<div class="paragraph"><p>All public clojure api for work with nanomsg library is exposed under <span class="monospaced">nanomsg</span> namespace,
and it consist on only few functions: <span class="monospaced">connect!</span>, <span class="monospaced">bind!</span>, <span class="monospaced">subscribe!</span>, <span class="monospaced">socket</span>, <span class="monospaced">send!</span>,
<span class="monospaced">recv!</span>, <span class="monospaced">send-bytes!</span>, <span class="monospaced">recv-bytes!</span>, <span class="monospaced">close!</span>, <span class="monospaced">terminate!</span> and <span class="monospaced">symbols</span> that are fairly self-descriptive.</p></div>
<div class="paragraph"><p>Example importing <span class="monospaced">nanomsg</span> namespace on clojure file:</p></div>
<div class="listingblock">
<div class="title"><em>yours/samplens.clj</em></div>
<div class="content"><div class="highlight"><pre><span class="p">(</span><span class="kd">ns </span><span class="nv">yours.samplens</span>
  <span class="p">(</span><span class="ss">:require</span> <span class="p">[</span><span class="nv">nanomsg</span> <span class="ss">:as</span> <span class="nv">nn</span><span class="p">]))</span>
</pre></div></div></div>
<div class="paragraph"><p>However, on java api, each protocol has it own package that contains a corresponding socket classes.</p></div>
<div class="sect3">
<h4 id="_connect_bind">5.1.1. Connect/Bind</h4>
<div class="sect4">
<h5 id="_clojure">Clojure</h5>
<div class="paragraph"><p>With clojure, you have two ways a do this: creating a socket and connection or do the
two operations in one, using <span class="monospaced">socket!</span> function optional parameters.</p></div>
<div class="paragraph"><p>Example of connect/bind operation using two steps:</p></div>
<div class="listingblock">
<div class="title"><em>client.clj</em></div>
<div class="content"><div class="highlight"><pre><span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">s</span> <span class="p">(</span><span class="nf">nn/socket</span> <span class="ss">:req</span><span class="p">)]</span>
  <span class="p">(</span><span class="nf">nn/connect!</span> <span class="nv">s</span> <span class="s">&quot;tcp:///tmp/sock&quot;</span><span class="p">))</span>
</pre></div></div></div>
<div class="listingblock">
<div class="title"><em>server.clj</em></div>
<div class="content"><div class="highlight"><pre><span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">s</span> <span class="p">(</span><span class="nf">nn/socket</span> <span class="ss">:rep</span><span class="p">)]</span>
  <span class="p">(</span><span class="nf">nn/bind!</span> <span class="nv">s</span> <span class="s">&quot;tcp:///tmp/sock&quot;</span><span class="p">))</span>
</pre></div></div></div>
<div class="paragraph"><p>Example of connect/bind operation using a single step:</p></div>
<div class="listingblock">
<div class="title"><em>client.clj</em></div>
<div class="content"><div class="highlight"><pre><span class="p">(</span><span class="nf">nn/socket</span> <span class="ss">:req</span> <span class="p">{</span><span class="ss">:connect</span> <span class="s">&quot;tcp:///tmp/sock&quot;</span><span class="p">})</span>
</pre></div></div></div>
<div class="listingblock">
<div class="title"><em>server.clj</em></div>
<div class="content"><div class="highlight"><pre><span class="p">(</span><span class="nf">nn/socket</span> <span class="ss">:rep</span> <span class="p">{</span><span class="ss">:bind</span> <span class="s">&quot;tcp:///tmp/sock&quot;</span><span class="p">})</span>
</pre></div></div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">On clojure, a socket types are represented by keywords. With this approach,
you can create any socket type with one unique function: <span class="monospaced">socket</span>. As you can see
on previous examples, I have used <span class="monospaced">:req</span> and <span class="monospaced">:rep</span> keywords for create respectively
<em>request</em> and <em>reply</em> socket types that are part of
<a href="http://nanomsg.org/v0.2/nn_reqrep.7.html">Req/Rep protocol</a></td>
</tr></table>
</div>
</div>
<div class="sect4">
<h5 id="_java">Java</h5>
<div class="paragraph"><p>With java, each socket class has it own connect/bind method.</p></div>
<div class="paragraph"><p>Here one example of how connect to a remote socket:</p></div>
<div class="listingblock">
<div class="title"><em>Client.java</em></div>
<div class="content"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">nanomsg.reqrep.ReqSocket</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Client</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">final</span> <span class="n">ReqSocket</span> <span class="n">s</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ReqSocket</span><span class="o">();</span>
        <span class="n">s</span><span class="o">.</span><span class="na">connect</span><span class="o">(</span><span class="s">&quot;tcp:///tmp/sock&quot;</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div></div></div>
<div class="paragraph"><p>And, here an example how to bind and listen on local socket:</p></div>
<div class="listingblock">
<div class="title"><em>Server.java</em></div>
<div class="content"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">nanomsg.reqrep.RepSocket</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Server</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">final</span> <span class="n">RepSocket</span> <span class="n">s</span> <span class="o">=</span> <span class="k">new</span> <span class="n">RepSocket</span><span class="o">();</span>
        <span class="n">s</span><span class="o">.</span><span class="na">bind</span><span class="o">(</span><span class="s">&quot;tcp:///tmp/sock&quot;</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div></div></div>
<div class="paragraph"><p>INFO: You can see in more detail a java api on <a href="api/java/index.html">javadoc</a>.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">With both languages, you can execute bind multiple times for listen
in multiple socket locations.</td>
</tr></table>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_pub_sub_sockets">5.2. Pub/Sub Sockets</h3>
<div class="paragraph"><p>This protocol has two socket types:</p></div>
<div class="ulist"><ul>
<li>
<p>
<em>publisher</em> - This socket is used to distribute messages to multiple destinations. Receive operation is not defined.
</p>
</li>
<li>
<p>
<em>subscriber</em> - Receives messages from the publisher. Only messages that the socket is subscribed to are received. When the socket is created there are no subscriptions and thus no messages will be received. Send operation is not defined on this socket.
</p>
</li>
</ul></div>
<div class="sect3">
<h4 id="_clojure_2">5.2.1. Clojure</h4>
<div class="paragraph"><p>Example of using pub/sub protocols in clojure:</p></div>
<div class="listingblock">
<div class="title"><em>publisher.clj</em></div>
<div class="content"><div class="highlight"><pre><span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">sock</span> <span class="p">(</span><span class="nf">nn/socket</span> <span class="ss">:pub</span><span class="p">)]</span>
  <span class="p">(</span><span class="nf">nn/bind!</span> <span class="nv">sock</span> <span class="s">&quot;ipc:///tmp/sock&quot;</span><span class="p">)</span>
  <span class="p">(</span><span class="nb">dotimes </span><span class="p">[</span><span class="nv">i</span> <span class="mi">5</span><span class="p">]</span>
    <span class="p">(</span><span class="nf">nn/send!</span> <span class="nv">sock</span> <span class="s">&quot;test msg&quot;</span><span class="p">))</span>
  <span class="p">(</span><span class="nf">nn/close!</span> <span class="nv">sock</span><span class="p">))</span>
</pre></div></div></div>
<div class="listingblock">
<div class="title"><em>subscriber.clj</em></div>
<div class="content"><div class="highlight"><pre><span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">sock</span> <span class="p">(</span><span class="nf">nn/socket</span> <span class="ss">:sub</span><span class="p">)]</span>
  <span class="p">(</span><span class="nf">nn/connect!</span> <span class="nv">sock</span> <span class="s">&quot;ipc:///tmp/sock&quot;</span><span class="p">)</span>
  <span class="p">(</span><span class="nf">nn/subscribe!</span> <span class="nv">sock</span> <span class="s">&quot;test&quot;</span><span class="p">)</span>
  <span class="p">(</span><span class="nb">dotimes </span><span class="p">[</span><span class="nv">i</span> <span class="mi">5</span><span class="p">]</span>
    <span class="p">(</span><span class="nb">println </span><span class="p">(</span><span class="nf">nn/recv</span> <span class="nv">sock</span><span class="p">)))</span>
  <span class="p">(</span><span class="nf">nn/close!</span> <span class="nv">sock</span><span class="p">))</span>
</pre></div></div></div>
</div>
<div class="sect3">
<h4 id="_java_2">5.2.2. Java</h4>
<div class="paragraph"><p>Example of using pub/sub protocols in clojure:</p></div>
<div class="listingblock">
<div class="title"><em>Publisher.java</em></div>
<div class="content"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">nanomsg.pubsub.PubSocket</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Publisher</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">PubSocket</span> <span class="n">sock</span> <span class="o">=</span> <span class="k">new</span> <span class="n">PubSocket</span><span class="o">();</span>
        <span class="n">sock</span><span class="o">.</span><span class="na">bind</span><span class="o">(</span><span class="s">&quot;ipc:///tmp/sock&quot;</span><span class="o">);</span>

        <span class="k">for</span><span class="o">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="o">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="mi">5</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
            <span class="n">sock</span><span class="o">.</span><span class="na">sendString</span><span class="o">(</span><span class="s">&quot;test msg&quot;</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="n">sock</span><span class="o">.</span><span class="na">close</span><span class="o">()</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div></div></div>
<div class="listingblock">
<div class="title"><em>Subscriber.java</em></div>
<div class="content"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">nanomsg.pubsub.SubSocket</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Subscriber</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">SubSocket</span> <span class="n">sock</span> <span class="o">=</span> <span class="k">new</span> <span class="n">SubSocket</span><span class="o">();</span>
        <span class="n">sock</span><span class="o">.</span><span class="na">connect</span><span class="o">(</span><span class="s">&quot;ipc:///tmp/sock&quot;</span><span class="o">);</span>
        <span class="n">sock</span><span class="o">.</span><span class="na">subscribe</span><span class="o">(</span><span class="s">&quot;test&quot;</span><span class="o">);</span>

        <span class="k">for</span><span class="o">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="o">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="mi">5</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">sock</span><span class="o">.</span><span class="na">recvString</span><span class="o">());</span>
        <span class="o">}</span>

        <span class="n">sock</span><span class="o">.</span><span class="na">close</span><span class="o">()</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div></div></div>
</div>
</div>
<div class="sect2">
<h3 id="_req_rep_sockets">5.3. Req/Rep Sockets</h3>
<div class="paragraph"><p>This protocol is used to distribute the workload among multiple stateless workers, and it&#8217;s represented
by two socket types:</p></div>
<div class="ulist"><ul>
<li>
<p>
<em>req</em> - Used to implement the client application that sends requests and receives replies.
</p>
</li>
<li>
<p>
<em>rep</em> - Used to implement the stateless worker that receives requests and sends replies.
</p>
</li>
</ul></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">Both sockets implements read and write methods.</td>
</tr></table>
</div>
<div class="sect3">
<h4 id="_clojure_3">5.3.1. Clojure</h4>
<div class="paragraph"><p>"Hello World" echo server using clojure:</p></div>
<div class="listingblock">
<div class="title"><em>rep.clj (server)</em></div>
<div class="content"><div class="highlight"><pre><span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">sock</span> <span class="p">(</span><span class="nf">nn/socket</span> <span class="ss">:rep</span><span class="p">)]</span>
  <span class="p">(</span><span class="nf">nn/bind!</span> <span class="nv">sock</span> <span class="s">&quot;tcp://*:6789&quot;</span><span class="p">)</span>
  <span class="p">(</span><span class="k">loop </span><span class="p">[]</span>
    <span class="p">(</span><span class="nf">nn/send!</span> <span class="nv">sock</span> <span class="p">(</span><span class="nf">nn/recv</span> <span class="nv">sock</span><span class="p">))</span>
    <span class="p">(</span><span class="nf">recur</span><span class="p">)))</span>
</pre></div></div></div>
<div class="listingblock">
<div class="title"><em>req.clj (client)</em></div>
<div class="content"><div class="highlight"><pre><span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">sock</span> <span class="p">(</span><span class="nf">nn/socket</span> <span class="ss">:req</span><span class="p">)]</span>
  <span class="p">(</span><span class="nf">nn/bind!</span> <span class="nv">sock</span> <span class="s">&quot;tcp://localhost:6789&quot;</span><span class="p">)</span>
  <span class="p">(</span><span class="nb">dotimes </span><span class="p">[</span><span class="nv">i</span> <span class="mi">5</span><span class="p">]</span>
    <span class="p">(</span><span class="nf">nn/send!</span> <span class="nv">sock</span> <span class="p">(</span><span class="nb">str </span><span class="s">&quot;msg:&quot;</span> <span class="mi">1</span><span class="p">))</span>
    <span class="p">(</span><span class="nb">println </span><span class="s">&quot;Received:&quot;</span> <span class="p">(</span><span class="nf">nn/recv</span> <span class="nv">sock</span><span class="p">)))</span>
  <span class="p">(</span><span class="nf">nn/close!</span> <span class="nv">sock</span><span class="p">))</span>
</pre></div></div></div>
</div>
<div class="sect3">
<h4 id="_java_3">5.3.2. Java</h4>
<div class="paragraph"><p>Same examples as on clojure section, but using java:</p></div>
<div class="listingblock">
<div class="title"><em>EchoServer.java</em></div>
<div class="content"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">nanomsg.reqrep.RepSocket</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">EchoServer</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">RepSocket</span> <span class="n">sock</span> <span class="o">=</span> <span class="k">new</span> <span class="n">RepSocket</span><span class="o">();</span>
        <span class="n">sock</span><span class="o">.</span><span class="na">bind</span><span class="o">(</span><span class="s">&quot;tcp://*:6789&quot;</span><span class="o">);</span>

        <span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="o">{</span>
            <span class="kt">byte</span><span class="o">[]</span> <span class="n">receivedData</span> <span class="o">=</span> <span class="n">sock</span><span class="o">.</span><span class="na">recvBytes</span><span class="o">();</span>
            <span class="n">sock</span><span class="o">.</span><span class="na">sendBytes</span><span class="o">(</span><span class="n">receivedData</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="n">sock</span><span class="o">.</span><span class="na">close</span><span class="o">()</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div></div></div>
<div class="listingblock">
<div class="title"><em>EchoClient.java</em></div>
<div class="content"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">nanomsg.reqrep.ReqSocket</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">EchoClient</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">ReqSocket</span> <span class="n">sock</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ReqSocket</span><span class="o">();</span>
        <span class="n">sock</span><span class="o">.</span><span class="na">connect</span><span class="o">(</span><span class="s">&quot;tcp://localhost:6789&quot;</span><span class="o">);</span>

        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="o">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="mi">5</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
            <span class="n">sock</span><span class="o">.</span><span class="na">sendString</span><span class="o">(</span><span class="s">&quot;Hello!&quot;</span> <span class="o">+</span> <span class="mi">1</span><span class="o">);</span>
            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;Received:&quot;</span> <span class="o">+</span> <span class="n">sock</span><span class="o">.</span><span class="na">recvString</span><span class="o">());</span>
        <span class="o">}</span>

        <span class="n">sock</span><span class="o">.</span><span class="na">close</span><span class="o">()</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div></div></div>
</div>
</div>
<div class="sect2">
<h3 id="_push_pull_sockets">5.4. Push/Pull Sockets</h3>
<div class="paragraph"><p>Scalability protocol for passing tasks through a series of processing steps and it&#8217;s represented
by two socket types:</p></div>
<div class="ulist"><ul>
<li>
<p>
<em>push</em> - This socket is used to send messages to a cluster of load-balanced nodes. Receive operation is not implemented on this socket type.
</p>
</li>
<li>
<p>
<em>pull</em> - This socket is used to receive a message from a cluster of nodes. Send operation is not implemented on this socket type.
</p>
</li>
</ul></div>
<div class="sect3">
<h4 id="_clojure_4">5.4.1. Clojure</h4>
<div class="paragraph"><p>"Hello World" task generator:</p></div>
<div class="listingblock">
<div class="title"><em>push.clj (server)</em></div>
<div class="content"><div class="highlight"><pre><span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">sock</span> <span class="p">(</span><span class="nf">nn/socket</span> <span class="ss">:push</span> <span class="p">{</span><span class="ss">:bind</span> <span class="s">&quot;tcp://*:6789&quot;</span><span class="p">})]</span>
  <span class="p">(</span><span class="nb">doseq </span><span class="p">[</span><span class="nb">name </span><span class="p">[</span><span class="s">&quot;Foo&quot;</span> <span class="s">&quot;Bar&quot;</span> <span class="s">&quot;Baz&quot;</span><span class="p">]]</span>
    <span class="p">(</span><span class="nf">nn/send!</span> <span class="nv">sock</span> <span class="nv">name</span><span class="p">))</span>
  <span class="p">(</span><span class="nf">nn/close!</span> <span class="nv">sock</span><span class="p">))</span>
</pre></div></div></div>
<div class="listingblock">
<div class="title"><em>pull.clj (client)</em></div>
<div class="content"><div class="highlight"><pre><span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">sock</span> <span class="p">(</span><span class="nf">nn/socket</span> <span class="ss">:pull</span> <span class="p">{</span><span class="ss">:connect</span> <span class="s">&quot;tcp://localhost:6789&quot;</span><span class="p">})]</span>
  <span class="p">(</span><span class="nb">dotimes </span><span class="p">[</span><span class="nv">i</span> <span class="mi">3</span><span class="p">]</span>
    <span class="p">(</span><span class="nb">println </span><span class="s">&quot;Hello &quot;</span> <span class="p">(</span><span class="nf">nn/recv!</span> <span class="nv">sock</span><span class="p">))))</span>
</pre></div></div></div>
</div>
<div class="sect3">
<h4 id="_java_4">5.4.2. Java</h4>
<div class="paragraph"><p>Same examples as on clojure section, but using java:</p></div>
<div class="listingblock">
<div class="title"><em>Dispatcher.java</em></div>
<div class="content"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">nanomsg.pipeline.PushSocket</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.ArrayList</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.List</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Dispatcher</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">PushSocket</span> <span class="n">sock</span> <span class="o">=</span> <span class="k">new</span> <span class="n">PushSocket</span><span class="o">();</span>
        <span class="n">sock</span><span class="o">.</span><span class="na">bind</span><span class="o">(</span><span class="s">&quot;tcp://*:6789&quot;</span><span class="o">);</span>

        <span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">people</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;();</span>
        <span class="n">people</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">&quot;Foo&quot;</span><span class="o">);</span>
        <span class="n">people</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">&quot;Bar&quot;</span><span class="o">);</span>
        <span class="n">people</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">&quot;Baz&quot;</span><span class="o">);</span>

        <span class="k">for</span><span class="o">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="o">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">people</span><span class="o">.</span><span class="na">size</span><span class="o">();</span> <span class="o">++</span><span class="n">i</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">sock</span><span class="o">.</span><span class="na">sendString</span><span class="o">(</span><span class="n">people</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">i</span><span class="o">));</span>
        <span class="o">}</span>

        <span class="n">sock</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div></div></div>
<div class="listingblock">
<div class="title"><em>Greeter.java</em></div>
<div class="content"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">nanomsg.pipeline.PullSocket</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Greeter</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">PullSocket</span> <span class="n">sock</span> <span class="o">=</span> <span class="k">new</span> <span class="n">PullSocket</span><span class="o">();</span>
        <span class="n">sock</span><span class="o">.</span><span class="na">connect</span><span class="o">(</span><span class="s">&quot;tcp://localhost:6789&quot;</span><span class="o">);</span>

        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="o">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="mi">3</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;Hello &quot;</span> <span class="o">+</span> <span class="n">sock</span><span class="o">.</span><span class="na">recvString</span><span class="o">());</span>
        <span class="o">}</span>

        <span class="n">sock</span><span class="o">.</span><span class="na">close</span><span class="o">()</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div></div></div>
</div>
</div>
<div class="sect2">
<h3 id="_async_support">5.5. Async support</h3>
<div class="paragraph"><p>Since version 0.3, <em>jnanomsg</em> comes with basic and experimental support for
asynchronous sockets for both languages.</p></div>
<div class="sect3">
<h4 id="_java_5">5.5.1. Java</h4>
<div class="paragraph"><p>Java bindings have same approach as some <span class="monospaced">java.nio</span> channels apis. Socket operations
takes a instance of any class that implements <span class="monospaced">nanomsg.async.IAsyncCallback</span>.</p></div>
<div class="paragraph"><p><span class="monospaced">IAsyncCallback</span> consists on two methods: <span class="monospaced">success(T data)</span> and <span class="monospaced">fail(Throwable t)</span>.</p></div>
<div class="paragraph"><p>This is a simple example of using it:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">nanomsg.pipeline.PullSocket</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">nanomsg.async.AsyncSocket</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">nanomsg.async.IAsyncCallback</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Greeter</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">final</span> <span class="n">PullSocket</span> <span class="n">sock</span> <span class="o">=</span> <span class="k">new</span> <span class="n">PullSocket</span><span class="o">();</span>
        <span class="kd">final</span> <span class="n">AsyncSocket</span> <span class="n">asyncSock</span> <span class="o">=</span> <span class="k">new</span> <span class="n">AsyncSocket</span><span class="o">(</span><span class="n">sock</span><span class="o">);</span>

        <span class="n">sock</span><span class="o">.</span><span class="na">connect</span><span class="o">(</span><span class="s">&quot;tcp://localhost:6789&quot;</span><span class="o">);</span>

        <span class="n">asyncSock</span><span class="o">.</span><span class="na">recvString</span><span class="o">(</span><span class="k">new</span> <span class="n">IAsyncCallback</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="o">{</span>
            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">success</span><span class="o">(</span><span class="kd">final</span> <span class="n">String</span> <span class="n">data</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;Hello &quot;</span> <span class="o">+</span> <span class="n">data</span><span class="o">);</span>
            <span class="o">}</span>

            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">fail</span><span class="o">(</span><span class="n">Throwable</span> <span class="n">t</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;Error: &quot;</span> <span class="o">+</span> <span class="n">t</span><span class="o">.</span><span class="na">toString</span><span class="o">());</span>
            <span class="o">}</span>
        <span class="o">});</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div></div></div>
</div>
<div class="sect3">
<h4 id="_clojure_5">5.5.2. Clojure</h4>
<div class="paragraph"><p>Clojure takes very different approach than java. For it, it uses <span class="monospaced">core.async</span> as dependency
(you always can use java/clojure api for implement the same behavior with other libraries,
such as <a href="http://daasd.com">Pulsar</a>).</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="p">(</span><span class="kd">ns </span><span class="nv">some.yourns</span>
  <span class="p">(</span><span class="ss">:require</span> <span class="p">[</span><span class="nv">clojure.core.async</span> <span class="ss">:as</span> <span class="nv">async</span><span class="p">]</span>
            <span class="p">[</span><span class="nv">nanomsg</span> <span class="ss">:as</span> <span class="nv">nn</span><span class="p">])</span>
  <span class="p">(</span><span class="ss">:gen-class</span><span class="p">))</span>

<span class="p">(</span><span class="kd">defn </span><span class="nv">-main</span>
  <span class="p">[</span><span class="o">&amp;</span> <span class="nv">args</span><span class="p">]</span>
  <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">s</span> <span class="p">(</span><span class="nf">nn/socket</span> <span class="ss">:pull</span> <span class="p">{</span><span class="ss">:connect</span> <span class="s">&quot;ipc:///tmp/sock&quot;</span> <span class="ss">:async</span> <span class="nv">true</span><span class="p">})]</span>
    <span class="p">(</span><span class="nf">go</span>
      <span class="p">(</span><span class="nb">dotimes </span><span class="p">[</span><span class="nv">i</span> <span class="mi">3</span><span class="p">]</span>
        <span class="p">(</span><span class="nb">println </span><span class="s">&quot;Hello: &quot;</span> <span class="p">(</span><span class="nf">async/&lt;!</span> <span class="p">(</span><span class="nf">nn/recv!</span> <span class="nv">s</span><span class="p">)))</span>
        <span class="p">(</span><span class="nf">recur</span><span class="p">)))))</span>
</pre></div></div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">async implementation is experimental and not efficient, because it uses a thread
pool for execute all blocking call instead of use epoll (or any other poll implementaitions).</td>
</tr></table>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_license">6. License</h2>
<div class="sectionbody">
<div class="listingblock">
<div class="content monospaced">
<pre>Copyright 2013 Andrey Antukh &lt;niwi@niwi.be&gt;

Licensed under the Apache License, Version 2.0 (the "License")
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.</pre>
</div></div>
</div>
</div>
</div>
<div id="footnotes"><hr></div>
<div id="footer">
<div id="footer-text">
Version 0.2.0<br>
Last updated 2014-01-27 20:52:58 CET
</div>
</div>
</body>
</html>
